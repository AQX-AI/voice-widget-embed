(()=>{const e=document.getElementById("talk-button"),t=document.getElementById("status"),o=(document.getElementById("local-audio"),document.querySelector("div"),document.getElementById("agent-image")),n=document.getElementById("aqx");o.classList.add("shadow");let a,s=null,d=null,r=null;function c(e){t.textContent=e}function i(e){document.documentElement.style.setProperty("--glow-color",e),document.documentElement.style.setProperty("--glow-color2",e),document.documentElement.style.setProperty("--glow-color3",e)}function l(e){"ai-agent.webp"===e?o.classList.add("shadow"):o.classList.remove("shadow"),o.classList.add("fade-out"),setTimeout((()=>{o.src=e,o.classList.remove("fade-out")}),200)}function u(e){n.classList.add("fade-out"),setTimeout((()=>{n.textContent=e,n.classList.remove("fade-out")}),200)}function w(){a&&a.stop()}async function m(e){e.stop(),document.body.classList.remove("recording")}e.addEventListener("click",(async()=>{if(console.log("click"),r)await m(r),r=null,d&&d.readyState===WebSocket.OPEN&&d.close();else try{r=await async function(){try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});try{return new MediaRecorder(e,{mimeType:"audio/webm"})}catch(t){try{return new MediaRecorder(e,{mimeType:"video/mp4"})}catch(e){return console.error({err1:t}),console.error({err2:e}),null}}}catch(e){throw console.error("Error accessing microphone:",e),e}}(),d=await(async()=>new Promise((async(o,n)=>{l("https://cdn.jsdelivr.net/gh/AQX-AI/voice-widget-embed@latest/loading.gif"),c("Connecting..."),i(window.buttonColors.connecting),e.disabled=!0;const d=window.apiKey;if(!d)return void(t.textContent="API key is required");const g={id:window.agentId,kbId:window.kbId,key:d,voiceModel:window.voiceModel},y=await fetch("https://aqx-ai-call-server-dtdwhtb8fcb7g8b0.eastus-01.azurewebsites.net/web",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)}),b=await y.json(),v=new WebSocket(`wss://aqx-ai-call-server-dtdwhtb8fcb7g8b0.eastus-01.azurewebsites.net/?callId=${b.callId}`);v.addEventListener("open",(()=>{console.log("Client: connected to server"),l("https://cdn.jsdelivr.net/gh/AQX-AI/voice-widget-embed@latest/answer-call.png"),c("End Call"),u("Connected | Powered by AQX.AI"),i(window.buttonColors.connected),e.disabled=!1;const t=JSON.stringify({event:"start"});v.send(t),o(v)})),v.onmessage=async e=>{console.log("Message received from server:",e.data);try{const t=JSON.parse(e.data);if("stop"===t.event&&w(),"media"===t.event&&t.media.payload){const e=t.media.payload,o=window.atob(e),n=o.length,d=new Uint8Array(n);for(let e=0;e<n;e++)d[e]=o.charCodeAt(e);const r=d.buffer;s||(s=new(window.AudioContext||window.webkitAudioContext));const c=await s.decodeAudioData(r);a=s.createBufferSource(),a.buffer=c,a.connect(s.destination),a.start()}}catch(e){console.error("Error handling WebSocket message:",e)}},v.addEventListener("close",(async()=>{console.log("Client: disconnected from server"),l("https://cdn.jsdelivr.net/gh/AQX-AI/voice-widget-embed@latest/ai-agent.webp"),c("Talk To AI"),u("Powered by AQX.AI"),i(window.buttonColors.base),w(),await m(r).then(r=null)})),v.addEventListener("error",(e=>{console.error("WebSocket error:",e),c("Disconnected"),n(e)}))})))(),await async function(e,t){return new Promise((o=>{e.onstart=()=>{console.log("Client: microphone opened"),document.body.classList.add("recording"),o()},e.onstop=()=>{console.log("Client: microphone closed"),document.body.classList.remove("recording")},e.ondataavailable=async e=>{if(console.log("Client: microphone data received"),e.data.size>0&&t.readyState===WebSocket.OPEN){const o=await e.data.arrayBuffer(),n=new Uint8Array(o),a=btoa(String.fromCharCode(...n)),s=JSON.stringify({event:"media",based:"web",media:{payload:a}});t.send(s)}},e.start(500)}))}(r,d)}catch(e){console.error("Error opening microphone or WebSocket:",e),c("Disconnected")}})),e.addEventListener("mouseover",(()=>{e.style.backgroundColor=void 0})),e.addEventListener("mouseout",(()=>{e.style.backgroundColor=void 0}))})();