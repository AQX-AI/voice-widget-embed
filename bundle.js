(()=>{const e=document.getElementById("talkButton"),o=document.getElementById("status"),t=document.getElementById("localAudio");let a,n,r,c=!1;e.addEventListener("click",(async function(){if(console.log("Initiating conversation"),window.apiKey)try{if(a||(a=new(window.AudioContext||window.webkitAudioContext)),!n){const e=await navigator.mediaDevices.getUserMedia({audio:!0});n=new MediaRecorder(e,{mimeType:"audio/webm"}),t.srcObject=e,n.ondataavailable=async e=>{if(e.data.size>0){console.log("Data available from MediaRecorder");try{const o=await e.data.arrayBuffer(),t=new Uint8Array(o),a=btoa(String.fromCharCode(...t)),n=JSON.stringify({event:"media",based:"web",media:{payload:a}});c?r.send(n):console.error("WebSocket is not open. Cannot send data.")}catch(e){console.error("Error processing media data:",e)}}},n.start(750)}r&&r.readyState!==WebSocket.CLOSED||(o.textContent="Connecting...",await fetch("https://aqx-ai-call-server-dtdwhtb8fcb7g8b0.eastus-01.azurewebsites.net//web",{method:"POST",headers:{"Content-Type":"application/json"}}),r=new WebSocket("wss://aqx-ai-call-server-dtdwhtb8fcb7g8b0.eastus-01.azurewebsites.net/"),r.onopen=()=>{console.log("WebSocket connection opened"),c=!0,o.textContent="Connected. Please start talking..."},r.onmessage=async e=>{console.log("Message received from server:",e.data);const o=JSON.parse(e.data);if("media"===o.event&&o.media.payload){const e=o.media.payload,t=window.atob(e),n=t.length,r=new Uint8Array(n);for(let e=0;e<n;e++)r[e]=t.charCodeAt(e);const c=r.buffer,s=await a.decodeAudioData(c),i=a.createBufferSource();i.buffer=s,i.connect(a.destination),i.start()}},r.onerror=e=>{console.error("WebSocket error:",e),o.textContent="WebSocket error"},r.onclose=e=>{console.log("WebSocket connection closed:",e),c=!1,o.textContent="Connection closed",n&&"inactive"!==n.state&&n.stop(),a&&"closed"!==a.state&&a.close().then((()=>{a=null}))})}catch(e){!function(e){let o="An error occurred while accessing media devices.";switch(e.name){case"NotAllowedError":o="Permission to access the microphone was denied.";break;case"NotFoundError":o="No microphone was found.";break;case"NotReadableError":o="The microphone is already in use by another application.";break;case"OverconstrainedError":o="The constraints specified are not supported by any available microphone.";break;case"AbortError":o="The operation was aborted.";break;default:o=`An unknown error occurred: ${e.message}`}alert(o),console.error(o,e)}(e)}else alert("API key not found")}))})();